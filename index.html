<!doctype html>
<html lang="en">

<head>
  <title>訂單修改系統</title>

  <link rel="stylesheet" href="css/main.css">

  <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />

  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>


  <link rel="stylesheet" href="css/loading.css" />
  <script src="js/loading.js"></script>
</head>

<body>
  <div id="loginDiv">
    <h1>管理員登入</h1>
    <div id="login" style="border-width:1px;border-style:solid;border-color:gray;padding-top: 30px; width: 680px;height: 180px; margin: 0 auto; margin-top: 30px">
      <div class="couponLabel" style="width: 150px; float: left; text-align: right">Email Address</div>
      <input id="emailAddress" class="couponInput" style="width: 440px" type="email" placeholder="請輸入 Email Address"><br>

      <div class="couponLabel" style="width: 150px; float: left; text-align: right">密 碼</div>
      <input id="password" class="couponInput" style="width: 440px" type="password" placeholder="請輸入密碼"><br>

      <button class="btn-blue" onclick="signIn()" style="margin-left: 350px"><i class="fa fa-sign-in"></i>&nbsp 登入</button>
<!--      <button class="btn-red" onclick="signInAbort()" style="margin-left: 30px"><i class="fa fa-thumbs-down"></i>&nbsp 放棄</button>-->
    </div>
  </div>
  
  <div id="mainDiv">
    <span class="couponLabel">訂單號碼</span><input class="couponInput" id="order_No" value="A161000032">
    <button class="btn-blue" onclick="downloadOrder()" style="float:none: 250px"><i class="fa fa-download"></i>&nbsp 下載資料</button>
    <button class="btn-red" onclick="signout()" style="float:none: 250px"><i class="fa fa-sign-out"></i>&nbsp 登出</button>    
    <hr> 
                                          
  </div>

  <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
<!--  <script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-analytics.js"></script>-->

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-firestore.js"></script>

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyAhr69v1SCFW5mwzfv-qfMA6xL0IhKHNrc",
      authDomain: "webchallenge-c16eb.firebaseapp.com",
      databaseURL: "https://webchallenge-c16eb.firebaseio.com",
      projectId: "webchallenge-c16eb",
      storageBucket: "webchallenge-c16eb.appspot.com",
      messagingSenderId: "372130663533",
      appId: "1:372130663533:web:d73219272c0b4faf7f8364",
      measurementId: "G-LZ3DN86LX1"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    var database = firebase.database();

    var authUser;
    var isLogin = false;
    
    firebase.auth().signOut();
    $("#mainDiv").hide();
    
    firebase.auth().onAuthStateChanged(function(user) {
      console.log(user);
      authUser = user;

      if (user == null) {
        // not login
        console.log("no login");
        isLogin = false;
      } else {
        // login
        console.log(user.email);
        isLogin = true;
        console.log("Login-in");
        $.loading.end();
        $("#loginDiv").hide();
        $("#mainDiv").show();
      }
      
    });

    function signIn() {
      //check email
      if (!validateEmail($("#emailAddress").val())) {
        $("#emailAddress").val("");
        $("#emailAddress").attr("placeholder", "Email Address Error, try again!");
        $("#emailAddress").css("background-color", "yellow");
      } else {
        $.loading.start("登入中");
        firebase.auth().signInWithEmailAndPassword($("#emailAddress").val(), $("#password").val()).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          alert("Login Error! Try again!")
          $.loading.end();
        });
      }
    }

    function validateEmail(email) {
      var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

      return re.test(String(email).toLowerCase());
    }


    function signInAbort() {
      console.log("signInAbort");
    }
    
    function signout(){
      console.log("signout");
      firebase.auth().signOut();  
      $("#emailAddress").val("");
      $("#password").val("");
      $("#loginDiv").show();
      $("#mainDiv").hide();      
    }
    
    function downloadOrder() {
      if (authUser == null) {
        isLogin = false;
        alert("請先登入");
        $("#loginDiv").show();        
        $("#mainDiv").hide(); 
        return 1;
      }
      
      console.log("downloadOrder");
      var request = new XMLHttpRequest();
      
//      request.open('GET', 'https://cvoscloud.azurewebsites.net/api/HC_Order_Main?OrderNo=A161000436&Code=debug123&VM=false', false);  

      var orderNO = $("#order_No").val();
      var paramToSend = 'https://curves-database-api.herokuapp.com/?API=01&Order_NO='+orderNO;
      console.log(paramToSend);
      
      $.loading.start("讀取訂單");      
//      request.open('GET', 'https://curves-database-api.herokuapp.com/?API=01&Order_NO=A161000032', true);
      request.open('GET', paramToSend, true);
      request.send();
      

      request.onload = function(e) {
        if (request.status === 200) {          
          //console.log(request.responseText);  
          resultObj = JSON.parse(request.responseText);
          aaa = JSON.parse(resultObj);
          //console.log(resultObj);
          $.loading.end();
        } else {
          $.loading.end();
          alert("訂單讀取失敗");
        }    
      }
      
//      orderObj = JSON.parse('{"perfs":[{"perfIdx":0,"perfName":"Get Order by OrderNo","duration":102,"durationString":"00:00:00.1024080"}],"errVer":1,"errPairs":[{"errCode":0,"errMsg":""}],"obj":{"id":"01989f40-a1dd-4194-870a-fdfd1c515a31","tableType":1,"order_No":"A161000436","previous_Order_No":"A161000032","sold_Franchise_Code":"A161","sold_Franchise_Name":"石牌店","belonging_Franchise_Code":"A161","belonging_Franchise_Name":"石牌店","member_No":"A161002853","member_Name":"林育蓮","mobile_No":"0956286536","monthly_Shipment_Date":20,"order_Date":"2019-11-12T00:00:00","firstShippingMonth":"2019-11-01T00:00:00","coach_Name":"阿南","birthday":"1991-10-20T00:00:00","email_Address":"laura6350098@gmail.com","receiver_Name":"林育蓮","receiver_TEL":"0956286536","receiver_Zip_Code":"112","receiver_City":null,"receiver_Town":null,"receiver_Address":"台北市北投區西安街一段313巷20-1號四樓","member_Type":"有效","fourIn1_Number":0,"lemon_Number":0,"matcha_Number":0,"sesame_Number":0,"pumpkinPeanut_Number":0,"tieguanyin_Number":1,"protein_Recurring_Number":1,"protein_Monthly_Charge":1380.0,"probiotics_Recurring_Number":0,"probiotics_Monthly_Charge":0.0,"credit_Card":true,"bank_Transfer":false,"credit_Card_No":"4649614883000397","credit_Card_Period":"2021-01-31T00:00:00","as_Member_Data":false,"credit_Card_Relation":"本人","credit_Card_Sign":null,"protein_Bank_Transfer_People":0,"protein_Bank_Transfer_Charge":0.0,"probiotics_Bank_Transfer_People":0,"probiotics_Bank_Transfer_Charge":0.0,"bank_Transfer_Date":"0001-01-01T00:00:00","bank_Transfer_No":null,"depositor_Without_Bankbook_Name":null,"confirm_Terms":true,"two_Copies_Invoice":true,"e_Invoice_Vehicle_No":null,"e_Invoice_Vehicle_Type":"E-mail寄送","three_Copies_Invoice":false,"tax_ID_Number":null,"invoice_Title":null,"notice_1":false,"notice_2":false,"notice_3":false,"notice_4":false,"notice_5":false,"notice_6":false,"time_FA":false,"time_FWO":false,"time_2W":false,"time_1WM":false,"time_2_3WM":false,"time_Over_3WM":true,"tools_BK":false,"tools_OpenL":false,"tools_ReservedL":false,"tools_PT":false,"tools_DM":false,"tools_None":true,"order_Sign":null,"order_Remark":null,"order_Status":"Z","submission_Date":"2019-11-12T14:32:44","approved_Date":"0001-01-01T00:00:00","approved":false,"funtion_Code":null,"created_Date":"0001-01-01T00:00:00","creator_ID":null,"creator_Name":null,"出貨時間歷史記錄":[],"suspend_Protein":false,"suspend_Probiotics":false,"suspend_Reason":null,"suspend_Start_Month":"0001-01-01T00:00:00","suspend_End_Month":"0001-01-01T00:00:00","suspend_Confirm_Terms":false,"recovery_Shipment_Month":"0001-01-01T00:00:00","recovery_Shipment_Day":"0001-01-01T00:00:00","cancel_Reason_Protein":null,"cancel_Confirm_Terms_Protein":false,"last_Shipment_Date_Protein":"0001-01-01T00:00:00","cancel_Reason_Probiotics":null,"cancel_Confirm_Terms_Probiotics":false,"last_Shipment_Date_Probiotics":"0001-01-01T00:00:00","最後刷卡時間":"0001-01-01T00:00:00","single_Delivery_Box":0,"import_Order_No":"","import_Time":"0001-01-01T00:00:00","is_Import":false,"import_Ship_History":[],"protein_Sold_Count":0,"probiotics_Sold_Count":0,"serverUpdateTime":"0001-01-01T00:00:00"}}');
      
      //console.log(orderObj.obj);
      
    }

    
  </script>



</body>

</html>